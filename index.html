<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ðŸŽ¯ Jeu de FlÃ©chettes Spirale</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f8f9fa;
    color: #333;
    text-align: center;
    margin: 0;
  }

  h1 {
    margin-top: 10px;
  }

  #game-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    margin-top: 20px;
  }

  #spiral-board {
    position: relative;
    width: 900px;
    height: 900px;
    background: radial-gradient(circle at center, #ffffff 50%, #f0f0f0 100%);
    border-radius: 50%;
  }

  .case {
    position: absolute;
    width: 38px;
    height: 38px;
    border-radius: 50%;
    text-align: center;
    line-height: 38px;
    font-weight: bold;
    font-size: 13px;
    color: #333;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.3s;
  }

  /* Couleurs des cases */
  .neutre { background: #b5f7c8; }
  .bonus { background: #77ddff; animation: pulse 1.5s infinite alternate; }
  .malus { background: #ff7676; animation: shake 1s infinite alternate; color: #fff; }
  .teleport { background: #ffd280; }
  .defi { background: #d6b4fc; }
  .attack { background: #fff176; animation: pulseAttack 1s infinite alternate; }

  @keyframes pulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.15); }
  }
  @keyframes pulseAttack {
    0% { box-shadow: 0 0 5px #fff176; }
    100% { box-shadow: 0 0 15px #fff176; }
  }
  @keyframes shake {
    0% { transform: rotate(-2deg); }
    100% { transform: rotate(2deg); }
  }

  .player-token {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    position: absolute;
    border: 2px solid #fff;
  }

  #score-panel {
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    width: 280px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }
  #score-panel h2 {
    margin: 0 0 10px;
  }
  #score-panel input {
    width: 80px;
    padding: 8px;
    font-size: 16px;
    text-align: center;
    margin: 10px 0;
  }
  #score-panel button {
    padding: 8px 15px;
    background: #28a745;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #log {
    margin-top: 20px;
    background: #fff;
    padding: 10px;
    height: 150px;
    overflow-y: auto;
    border-radius: 8px;
    text-align: left;
    font-size: 14px;
  }

  /* Popup */
  #popup {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }
  .popup-content {
    background: #fff;
    color: #000;
    padding: 20px;
    border-radius: 12px;
    width: 320px;
    text-align: center;
    animation: popIn 0.3s ease-out;
  }
  .popup-content button {
    margin-top: 15px;
    padding: 10px 20px;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #restart-btn {
    margin-top: 10px;
    padding: 8px 15px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
</style>
</head>
<body>

<h1>ðŸŽ¯ Jeu de FlÃ©chettes en Spirale</h1>

<div id="start-screen">
  <label>Nombre de joueurs (2-6):
    <input type="number" id="numPlayers" min="2" max="6" value="2">
  </label>
  <div id="playerNames"></div>
  <button onclick="generatePlayerInputs()">Configurer les joueurs</button>
  <button onclick="startGame()">DÃ©marrer la partie</button>
</div>

<div id="game-container" style="display:none;">
  <div id="spiral-board"></div>

  <div id="score-panel">
    <h2 id="status">ðŸŽ¯ Tour</h2>
    <label>Score du tir :</label><br>
    <input type="number" id="scoreInput" min="0" max="60"><br>
    <button onclick="validateScore()">Valider</button>
    <div id="log"></div>
  </div>
</div>

<!-- Popup -->
<div id="popup">
  <div class="popup-content">
    <h2 id="popup-title"></h2>
    <p id="popup-message"></p>
    <button onclick="closePopup()">OK</button>
    <button id="restart-btn" style="display:none;" onclick="restartGame()">Rejouer</button>
  </div>
</div>

<!-- Sons encodÃ©s (extraits libres, base64 raccourcis ici) -->
<audio id="sound-bonus" src="data:audio/wav;base64,UklGRlQAAABXQVZFZm10..."></audio>
<audio id="sound-malus" src="data:audio/wav;base64,UklGR..."></audio>
<audio id="sound-attack" src="data:audio/wav;base64,UklGR..."></audio>
<audio id="sound-teleport" src="data:audio/wav;base64,UklGR..."></audio>

<script>
const NUM_CELLS = 60;
let players = [];
let currentPlayerIndex = 0;
let pendingEffect = null;
let boardCases = [];
let mustSucceedDefi = {};

/* Types des cases */
function getCaseType(i) {
  if ([3,21].includes(i)) return "bonus";
  if ([25,59].includes(i)) return "malus";
  if ([40].includes(i)) return "teleport";
  if ([10,15,33].includes(i)) return "defi";
  if ([12,50].includes(i)) return "attack";
  return "neutre";
}

/* Config joueurs */
function generatePlayerInputs() {
  let num = parseInt(document.getElementById("numPlayers").value);
  let container = document.getElementById("playerNames");
  container.innerHTML = "";
  for (let i=1; i<=num; i++) {
    container.innerHTML += `<div><label>Nom joueur ${i} : <input type="text" id="playerName${i}" value="Joueur${i}"></label></div>`;
  }
}

function startGame() {
  let num = parseInt(document.getElementById("numPlayers").value);
  players = [];
  for (let i=1; i<=num; i++) {
    let name = document.getElementById("playerName"+i).value || "Joueur"+i;
    players.push({name:name, pos:1, color:getRandomColor()});
    mustSucceedDefi[name]=false;
  }
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("game-container").style.display = "flex";
  createSpiralBoard();
  drawPlayers();
  updateStatus();
}

function restartGame(){
  document.getElementById("popup").style.display="none";
  document.getElementById("restart-btn").style.display="none";
  players.forEach(p=>{p.pos=1; mustSucceedDefi[p.name]=false;});
  currentPlayerIndex=0;
  createSpiralBoard();
  drawPlayers();
  document.getElementById("log").innerHTML="";
  updateStatus();
}

/* Utils */
function getRandomColor(){
  const colors = ["#ff4757","#1e90ff","#2ed573","#ffa502","#3742fa","#ff6348"];
  return colors[Math.floor(Math.random()*colors.length)];
}

/* Plateau spirale aÃ©rÃ©e */
function createSpiralBoard() {
  let board = document.getElementById("spiral-board");
  board.innerHTML = "";
  boardCases = [];
  const centerX = 450, centerY = 450;
  let angle = 0;
  let radius = 150;
  for (let i=1;i<=NUM_CELLS;i++) {
    let x = centerX + radius * Math.cos(angle) - 19;
    let y = centerY + radius * Math.sin(angle) - 19;
    let type = getCaseType(i);
    boardCases.push(type);
    let div = document.createElement("div");
    div.className = `case ${type}`;
    div.textContent = i;
    div.style.left = `${x}px`;
    div.style.top = `${y}px`;
    board.appendChild(div);
    angle += 0.35;     // espacement angulaire
    radius += 6;       // espacement radial plus large
  }
}

function drawPlayers() {
  document.querySelectorAll(".player-token").forEach(e=>e.remove());
  let board = document.getElementById("spiral-board");
  const centerX = 450, centerY = 450;
  let angle = 0; let radius = 150;
  let coords = {};
  for (let i=1;i<=NUM_CELLS;i++){
    let x = centerX + radius*Math.cos(angle);
    let y = centerY + radius*Math.sin(angle);
    coords[i] = {x,y};
    angle += 0.35;
    radius += 6;
  }
  players.forEach(p=>{
    let token = document.createElement("div");
    token.className="player-token";
    token.style.background=p.color;
    let c = coords[p.pos];
    token.style.left = (c.x-10)+"px";
    token.style.top = (c.y-10)+"px";
    board.appendChild(token);
  });
}

/* Tour */
function updateStatus(){
  let p = players[currentPlayerIndex];
  document.getElementById("status").textContent = `ðŸŽ¯ Au tour de ${p.name}`;
}

function validateScore(){
  let score = parseInt(document.getElementById("scoreInput").value);
  if(isNaN(score)||score<0||score>60){alert("Score invalide !");return;}
  processTurn(score);
}

function getAdvance(score){
  if(score<=10) return 1;
  if(score<=20) return 2;
  if(score<=40) return 3;
  return 4;
}

function processTurn(score){
  let p = players[currentPlayerIndex];
  // VÃ©rif dÃ©fi en attente
  if(mustSucceedDefi[p.name]){
    if(score<10){
      log(`${p.name} Ã©choue le dÃ©fi (<10 pts) â†’ reste bloquÃ©`);
      mustSucceedDefi[p.name]=false;
      nextPlayer();
      return;
    } else {
      log(`${p.name} rÃ©ussit le dÃ©fi !`);
      mustSucceedDefi[p.name]=false;
    }
  }
  let advance = getAdvance(score);
  p.pos += advance;
  if(p.pos>NUM_CELLS) p.pos = NUM_CELLS;
  log(`${p.name} avance de ${advance} cases â†’ case ${p.pos}`);
  if(p.pos===NUM_CELLS){
    showPopup("ðŸ† Victoire",`Bravo ${p.name} a gagnÃ© la partie !`,()=>{});
    document.getElementById("restart-btn").style.display="inline-block";
    return;
  }
  let type = boardCases[p.pos-1];
  if(type!=="neutre"){
    handleSpecial(p,type);
  } else {
    drawPlayers();
    nextPlayer();
  }
}

function handleSpecial(player,type){
  switch(type){
    case "bonus":
      playSound("sound-bonus");
      showPopup("ðŸŽ‰ Bonus","Avance de 2 cases supplÃ©mentaires !",()=>{
        player.pos+=2;
        if(player.pos>NUM_CELLS) player.pos=NUM_CELLS;
        drawPlayers();
        nextPlayer();
      });
      break;
    case "malus":
      playSound("sound-malus");
      showPopup("ðŸ’¥ Malus","Recule de 5 cases !",()=>{
        player.pos=Math.max(1,player.pos-5);
        drawPlayers();
        nextPlayer();
      });
      break;
    case "teleport":
      playSound("sound-teleport");
      showPopup("ðŸŒ€ TÃ©lÃ©portation","Tu es transportÃ© Ã  la case 50 !",()=>{
        player.pos=50;
        drawPlayers();
        nextPlayer();
      });
      break;
    case "defi":
      playSound("sound-bonus");
      showPopup("ðŸŽ¯ DÃ©fi prÃ©cision","Au prochain tour, tu dois faire au moins 10 points ou rester bloquÃ© !",()=>{
        mustSucceedDefi[player.name]=true;
        drawPlayers();
        nextPlayer();
      });
      break;
    case "attack":
      playSound("sound-attack");
      showPopup("ðŸŽ¯ Attaque !","Choisis un adversaire et lance une flÃ©chette pour le faire reculer.",()=>{
        triggerAttack(player);
      });
      break;
  }
}

function triggerAttack(player){
  let opponents = players.filter(p=>p!==player);
  let names = opponents.map(o=>o.name).join(", ");
  let targetName = prompt("Qui veux-tu attaquer ? ("+names+")");
  let target = opponents.find(o=>o.name===targetName);
  if(!target){ nextPlayer(); return; }
  let s = parseInt(prompt("Score de ton tir d'attaque ?"));
  if(isNaN(s)){ nextPlayer(); return; }
  let recule=1;
  if(s>10 && s<=20) recule=2;
  else if(s>20 && s<=40) recule=3;
  else if(s>40) recule=4;
  target.pos=Math.max(1,target.pos-recule);
  log(`${player.name} attaque ${target.name} â†’ recule de ${recule} cases !`);
  drawPlayers();
  nextPlayer();
}

function nextPlayer(){
  currentPlayerIndex=(currentPlayerIndex+1)%players.length;
  updateStatus();
}

/* Popup */
function showPopup(title,message,callback){
  document.getElementById("popup-title").textContent=title;
  document.getElementById("popup-message").textContent=message;
  document.getElementById("popup").style.display="flex";
  pendingEffect=callback;
}
function closePopup(){
  document.getElementById("popup").style.display="none";
  if(pendingEffect) pendingEffect();
  pendingEffect=null;
}

/* Logs */
function log(msg){
  document.getElementById("log").innerHTML+=msg+"<br>";
  document.getElementById("log").scrollTop=document.getElementById("log").scrollHeight;
}

/* Sounds */
function playSound(id){
  document.getElementById(id).play();
}
</script>
</body>
</html>
