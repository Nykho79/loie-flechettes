<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ðŸŽ¯ Jeu de FlÃ©chettes - Mode Serpent Complet</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    color: #333;
    margin: 0;
    text-align: center;
  }

  h1 {
    margin: 15px 0;
  }

  #game-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    margin: 15px;
  }

  #board-container {
    background: #fff;
    padding: 10px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  /* Plateau en grille responsive */
  #board {
    display: grid;
    grid-template-rows: repeat(6, min(7vw,70px));
    grid-template-columns: repeat(10, min(7vw,70px));
    gap: 4px;
  }

  .case {
    width: min(7vw,70px);
    height: min(7vw,70px);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 13px;
    position: relative;
    text-align: center;
  }

  /* Couleurs cases */
  .neutre { background: #dfffea; }
  .bonus { background: #8fd6ff; }
  .malus { background: #ff6f6f; color: #fff; }
  .teleport { background: #ffd280; }
  .defi { background: #dab4fc; }
  .attack { background: #fff176; }

  /* Zone joueurs (multi-emoji) */
  .player-slot {
    position: absolute;
    bottom: 2px;
    left: 2px;
    display: flex;
    gap: 2px;
    font-size: 18px;
  }

  /* Panneau de contrÃ´le */
  #score-panel {
    background: #fff;
    border-radius: 10px;
    padding: 15px;
    width: 260px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }
  #score-panel h2 {
    margin: 0 0 10px;
  }
  #score-panel select {
    width: 100%;
    padding: 4px;
    margin-bottom: 8px;
  }
  #score-panel button {
    padding: 8px 15px;
    background: #28a745;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #bareme {
    margin-top:10px;
    text-align:left;
    font-size:14px;
    background:#f7f7f7;
    padding:8px;
    border-radius:6px;
  }

  #log {
    margin-top: 15px;
    background: #fafafa;
    padding: 8px;
    height: 120px;
    overflow-y: auto;
    border-radius: 8px;
    text-align: left;
    font-size: 13px;
  }

  /* Popup */
  #popup {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }
  .popup-content {
    background: #fff;
    color: #000;
    padding: 20px;
    border-radius: 12px;
    width: 300px;
    text-align: center;
    animation: popIn 0.3s ease-out;
  }
  .popup-content button {
    margin-top: 10px;
    padding: 8px 15px;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #restart-btn {
    margin-top: 8px;
    padding: 6px 12px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  /* IcÃ´ne d'effet sur les cases spÃ©ciales */
  .effect-icon {
    font-size: 16px;
    margin-top: 3px;
  }
</style>
</head>
<body>

<h1>ðŸŽ¯ Jeu de FlÃ©chettes - Mode Serpent Complet</h1>

<div id="start-screen">
  <label>Nombre de joueurs (2-6):
    <input type="number" id="numPlayers" min="2" max="6" value="2">
  </label>
  <div id="playerNames"></div>
  <button onclick="generatePlayerInputs()">Configurer les joueurs</button>
  <button onclick="startGame()">DÃ©marrer la partie</button>
</div>

<div id="game-container" style="display:none;">
  <div id="board-container">
    <div id="board"></div>
  </div>

  <div id="score-panel">
    <h2 id="status">ðŸŽ¯ Tour</h2>
    
    <label>FlÃ©chette 1 :</label><br>
    <select id="d1"></select><br>
    <label>FlÃ©chette 2 :</label><br>
    <select id="d2"></select><br>
    <label>FlÃ©chette 3 :</label><br>
    <select id="d3"></select><br>
    <button onclick="validateScore()">Valider</button>
    
    <div id="bareme">
      <strong>ðŸŽ¯ BarÃ¨me de dÃ©placement (3 flÃ©chettes) :</strong><br>
      â€¢ 0 Ã  30 pts â†’ avance <strong>1 case</strong><br>
      â€¢ 31 Ã  60 pts â†’ avance <strong>2 cases</strong><br>
      â€¢ 61 Ã  100 pts â†’ avance <strong>3 cases</strong><br>
      â€¢ 101 Ã  150 pts â†’ avance <strong>4 cases</strong>
    </div>

    <div id="log"></div>
  </div>
</div>

<!-- Popup -->
<div id="popup">
  <div class="popup-content">
    <h2 id="popup-title"></h2>
    <p id="popup-message"></p>
    <button onclick="closePopup()">OK</button>
    <button id="restart-btn" style="display:none;" onclick="restartGame()">Rejouer</button>
  </div>
</div>

<script>
const NUM_CELLS = 60;
let players = [];
let currentPlayerIndex = 0;
let pendingEffect = null;
let boardCases = [];
let mustSucceedDefi = {};

const playerEmojis = ["ðŸ”´","ðŸ”µ","ðŸŸ¢","ðŸŸ£","ðŸŸ ","ðŸŸ¡"];

// Types de cases et icÃ´ne
function getCaseType(i) {
  if ([3,21].includes(i)) return "bonus";
  if ([25,59].includes(i)) return "malus";
  if ([40].includes(i)) return "teleport";
  if ([10,15,33].includes(i)) return "defi";
  if ([12,50].includes(i)) return "attack";
  return "neutre";
}
function getEffectIcon(type){
  switch(type){
    case "bonus": return "âœ…";
    case "malus": return "âŒ";
    case "teleport": return "ðŸŒ€";
    case "defi": return "ðŸŽ¯";
    case "attack": return "âš”ï¸";
    default: return "";
  }
}

// GÃ©nÃ©rer les options de score rÃ©alistes
function fillScoreSelects(){
  const vals = [0,...Array.from({length:20},(_,i)=>i+1),25,50];
  const selects = [document.getElementById("d1"),document.getElementById("d2"),document.getElementById("d3")];
  selects.forEach(sel=>{
    sel.innerHTML="";
    vals.forEach(v=>{
      let opt = document.createElement("option");
      opt.value=v;
      opt.textContent=v;
      sel.appendChild(opt);
    });
  });
}

function generatePlayerInputs() {
  let num = parseInt(document.getElementById("numPlayers").value);
  let container = document.getElementById("playerNames");
  container.innerHTML = "";
  for (let i=1; i<=num; i++) {
    container.innerHTML += `<div><label>Nom joueur ${i} : <input type="text" id="playerName${i}" value="Joueur${i}"></label></div>`;
  }
}

function startGame() {
  let num = parseInt(document.getElementById("numPlayers").value);
  players = [];
  for (let i=1; i<=num; i++) {
    let name = document.getElementById("playerName"+i).value || "Joueur"+i;
    players.push({name:name, pos:1, emoji: playerEmojis[i-1]});
    mustSucceedDefi[name]=false;
  }
  fillScoreSelects();
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("game-container").style.display = "flex";
  createSerpentBoard();
  drawPlayers();
  updateStatus();
}

function restartGame(){
  document.getElementById("popup").style.display="none";
  document.getElementById("restart-btn").style.display="none";
  players.forEach(p=>{p.pos=1; mustSucceedDefi[p.name]=false;});
  currentPlayerIndex=0;
  createSerpentBoard();
  drawPlayers();
  document.getElementById("log").innerHTML="";
  updateStatus();
}

// Plateau serpent avec icÃ´ne dâ€™effet
function createSerpentBoard(){
  const board = document.getElementById("board");
  board.innerHTML = "";
  boardCases = [];
  let rows = 6;
  let cols = 10;
  let count = 1;
  for(let r=0; r<rows; r++){
    let rowCells = [];
    for(let c=0; c<cols; c++){
      let type = getCaseType(count);
      boardCases.push(type);

      let div = document.createElement("div");
      div.className = `case ${type}`;
      let icon = getEffectIcon(type);
      div.innerHTML = count + (icon ? `<div class="effect-icon">${icon}</div>` : "");
      rowCells.push(div);
      count++;
    }
    if(r%2===1) rowCells.reverse();
    rowCells.forEach(cell => board.appendChild(cell));
  }
}

// Affichage multi-emojis sur une case
function drawPlayers(){
  document.querySelectorAll(".player-slot").forEach(e=>e.remove());
  const allCases = document.getElementById("board").children;
  let grouped = {};
  players.forEach(p=>{
    if(!grouped[p.pos]) grouped[p.pos]=[];
    grouped[p.pos].push(p.emoji);
  });
  Object.keys(grouped).forEach(pos=>{
    let idx = parseInt(pos)-1;
    let caseDiv = allCases[idx];
    let slot = document.createElement("div");
    slot.className="player-slot";
    grouped[pos].forEach(em=> {
      let span = document.createElement("span");
      span.textContent = em;
      slot.appendChild(span);
    });
    caseDiv.appendChild(slot);
  });
}

// Tour
function updateStatus(){
  let p = players[currentPlayerIndex];
  document.getElementById("status").textContent = `ðŸŽ¯ Au tour de ${p.name} ${p.emoji}`;
}

function validateScore(){
  let s1 = parseInt(document.getElementById("d1").value) || 0;
  let s2 = parseInt(document.getElementById("d2").value) || 0;
  let s3 = parseInt(document.getElementById("d3").value) || 0;
  let total = s1+s2+s3;
  processTurn(total);
}

// BarÃ¨me pour 3 flÃ©chettes (max 150)
function getAdvance(total){
  if(total <= 30) return 1;
  if(total <= 60) return 2;
  if(total <= 100) return 3;
  return 4;
}

function processTurn(total){
  let p = players[currentPlayerIndex];

  if(mustSucceedDefi[p.name]){
    if(total<30){
      log(`${p.name} Ã©choue le dÃ©fi (<30 pts total) â†’ reste bloquÃ©`);
      mustSucceedDefi[p.name]=false;
      nextPlayer();
      return;
    } else {
      log(`${p.name} rÃ©ussit le dÃ©fi !`);
      mustSucceedDefi[p.name]=false;
    }
  }

  let advance = getAdvance(total);
  p.pos += advance;
  if(p.pos>NUM_CELLS) p.pos = NUM_CELLS;
  log(`${p.name} a fait ${total} pts â†’ avance de ${advance} cases â†’ case ${p.pos}`);

  if(p.pos===NUM_CELLS){
    showPopup("ðŸ† Victoire",`Bravo ${p.name} a gagnÃ© la partie !`,()=>{});
    document.getElementById("restart-btn").style.display="inline-block";
    return;
  }

  let type = boardCases[p.pos-1];
  if(type!=="neutre"){
    handleSpecial(p,type);
  } else {
    drawPlayers();
    nextPlayer();
  }
}

function handleSpecial(player,type){
  switch(type){
    case "bonus":
      showPopup("ðŸŽ‰ Bonus","Avance de 2 cases supplÃ©mentaires !",()=>{
        player.pos+=2;
        if(player.pos>NUM_CELLS) player.pos=NUM_CELLS;
        drawPlayers();
        nextPlayer();
      });
      break;
    case "malus":
      showPopup("ðŸ’¥ Malus","Recule de 5 cases !",()=>{
        player.pos=Math.max(1,player.pos-5);
        drawPlayers();
        nextPlayer();
      });
      break;
    case "teleport":
      showPopup("ðŸŒ€ TÃ©lÃ©portation","Tu es transportÃ© Ã  la case 50 !",()=>{
        player.pos=50;
        drawPlayers();
        nextPlayer();
      });
      break;
    case "defi":
      showPopup("ðŸŽ¯ DÃ©fi prÃ©cision","Au prochain tour, tu dois faire au moins 30 points (sur 3 flÃ©chettes) ou rester bloquÃ© !",()=>{
        mustSucceedDefi[player.name]=true;
        drawPlayers();
        nextPlayer();
      });
      break;
    case "attack":
      showPopup("âš”ï¸ Attaque !","Choisis un adversaire et lance 1 flÃ©chette pour le faire reculer.",()=>{
        triggerAttack(player);
      });
      break;
  }
}

function triggerAttack(player){
  let opponents = players.filter(p=>p!==player);
  let names = opponents.map(o=>o.name).join(", ");
  let targetName = prompt("Qui veux-tu attaquer ? ("+names+")");
  let target = opponents.find(o=>o.name===targetName);
  if(!target){ nextPlayer(); return; }
  let s = parseInt(prompt("Score de ton tir d'attaque (0,1-20,25,50) ?")) || 0;
  let recule=1;
  if(s>10 && s<=20) recule=2;
  else if(s>20 && s<=40) recule=3;
  else if(s>40) recule=4;
  target.pos=Math.max(1,target.pos-recule);
  log(`${player.name} attaque ${target.name} â†’ recule de ${recule} cases !`);
  drawPlayers();
  nextPlayer();
}

function nextPlayer(){
  currentPlayerIndex=(currentPlayerIndex+1)%players.length;
  updateStatus();
}

// Popup
function showPopup(title,message,callback){
  document.getElementById("popup-title").textContent=title;
  document.getElementById("popup-message").textContent=message;
  document.getElementById("popup").style.display="flex";
  pendingEffect=callback;
}
function closePopup(){
  document.getElementById("popup").style.display="none";
  if(pendingEffect) pendingEffect();
  pendingEffect=null;
}

// Logs
function log(msg){
  document.getElementById("log").innerHTML+=msg+"<br>";
  document.getElementById("log").scrollTop=document.getElementById("log").scrollHeight;
}
</script>
</body>
</html>
