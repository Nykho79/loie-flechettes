<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>🎯 Jeu de Fléchettes - Mode Serpent</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    color: #333;
    margin: 0;
    text-align: center;
  }

  h1 {
    margin: 20px 0;
  }

  #game-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 30px;
    margin: 20px;
  }

  #board-container {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  #board {
    display: grid;
    grid-template-rows: repeat(6, 60px);
    grid-template-columns: repeat(10, 60px);
    gap: 5px;
  }

  .case {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  /* Couleurs des cases */
  .neutre { background: #dfffea; color: #333; }
  .bonus { background: #8fd6ff; animation: pulse 1.5s infinite alternate; }
  .malus { background: #ff6f6f; color: #fff; animation: shake 1.2s infinite alternate; }
  .teleport { background: #ffd280; }
  .defi { background: #dab4fc; }
  .attack { background: #fff176; animation: pulseAttack 1s infinite alternate; }

  @keyframes pulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.1); }
  }
  @keyframes pulseAttack {
    0% { box-shadow: 0 0 5px #fff176; }
    100% { box-shadow: 0 0 15px #fff176; }
  }
  @keyframes shake {
    0% { transform: rotate(-1deg); }
    100% { transform: rotate(1deg); }
  }

  .player-token {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid #fff;
    position: absolute;
  }

  #score-panel {
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    width: 280px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }
  #score-panel h2 {
    margin: 0 0 10px;
  }
  #score-panel input {
    width: 80px;
    padding: 8px;
    font-size: 16px;
    text-align: center;
    margin: 10px 0;
  }
  #score-panel button {
    padding: 8px 15px;
    background: #28a745;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #log {
    margin-top: 20px;
    background: #fff;
    padding: 10px;
    height: 150px;
    overflow-y: auto;
    border-radius: 8px;
    text-align: left;
    font-size: 14px;
  }

  /* Popup */
  #popup {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }
  .popup-content {
    background: #fff;
    color: #000;
    padding: 20px;
    border-radius: 12px;
    width: 320px;
    text-align: center;
    animation: popIn 0.3s ease-out;
  }
  .popup-content button {
    margin-top: 15px;
    padding: 10px 20px;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #restart-btn {
    margin-top: 10px;
    padding: 8px 15px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
</style>
</head>
<body>

<h1>🎯 Jeu de Fléchettes - Mode Serpent</h1>

<div id="start-screen">
  <label>Nombre de joueurs (2-6):
    <input type="number" id="numPlayers" min="2" max="6" value="2">
  </label>
  <div id="playerNames"></div>
  <button onclick="generatePlayerInputs()">Configurer les joueurs</button>
  <button onclick="startGame()">Démarrer la partie</button>
</div>

<div id="game-container" style="display:none;">
  <div id="board-container">
    <div id="board"></div>
  </div>

  <div id="score-panel">
    <h2 id="status">🎯 Tour</h2>
    <label>Score du tir :</label><br>
    <input type="number" id="scoreInput" min="0" max="60"><br>
    <button onclick="validateScore()">Valider</button>
    <div id="log"></div>
  </div>
</div>

<!-- Popup -->
<div id="popup">
  <div class="popup-content">
    <h2 id="popup-title"></h2>
    <p id="popup-message"></p>
    <button onclick="closePopup()">OK</button>
    <button id="restart-btn" style="display:none;" onclick="restartGame()">Rejouer</button>
  </div>
</div>

<script>
const NUM_CELLS = 60;
let players = [];
let currentPlayerIndex = 0;
let pendingEffect = null;
let boardCases = [];
let mustSucceedDefi = {};

/* Types des cases */
function getCaseType(i) {
  if ([3,21].includes(i)) return "bonus";
  if ([25,59].includes(i)) return "malus";
  if ([40].includes(i)) return "teleport";
  if ([10,15,33].includes(i)) return "defi";
  if ([12,50].includes(i)) return "attack";
  return "neutre";
}

/* Génération joueurs */
function generatePlayerInputs() {
  let num = parseInt(document.getElementById("numPlayers").value);
  let container = document.getElementById("playerNames");
  container.innerHTML = "";
  for (let i=1; i<=num; i++) {
    container.innerHTML += `<div><label>Nom joueur ${i} : <input type="text" id="playerName${i}" value="Joueur${i}"></label></div>`;
  }
}

function startGame() {
  let num = parseInt(document.getElementById("numPlayers").value);
  players = [];
  for (let i=1; i<=num; i++) {
    let name = document.getElementById("playerName"+i).value || "Joueur"+i;
    players.push({name:name, pos:1, color:getRandomColor()});
    mustSucceedDefi[name]=false;
  }
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("game-container").style.display = "flex";
  createSerpentBoard();
  drawPlayers();
  updateStatus();
}

function restartGame(){
  document.getElementById("popup").style.display="none";
  document.getElementById("restart-btn").style.display="none";
  players.forEach(p=>{p.pos=1; mustSucceedDefi[p.name]=false;});
  currentPlayerIndex=0;
  createSerpentBoard();
  drawPlayers();
  document.getElementById("log").innerHTML="";
  updateStatus();
}

function getRandomColor(){
  const colors = ["#ff4757","#1e90ff","#2ed573","#ffa502","#3742fa","#ff6348"];
  return colors[Math.floor(Math.random()*colors.length)];
}

/* Création plateau mode serpent */
function createSerpentBoard(){
  const board = document.getElementById("board");
  board.innerHTML = "";
  boardCases = [];
  let rows = 6;
  let cols = 10;

  let count = 1;
  for(let r=0; r<rows; r++){
    let rowCells = [];
    for(let c=0; c<cols; c++){
      let type = getCaseType(count);
      boardCases.push(type);

      let div = document.createElement("div");
      div.className = `case ${type}`;
      div.textContent = count;
      rowCells.push(div);
      count++;
    }
    // serpent : inverser une ligne sur deux
    if(r%2===1) rowCells.reverse();
    rowCells.forEach(cell => board.appendChild(cell));
  }
}

/* Affichage des pions */
function drawPlayers(){
  document.querySelectorAll(".player-token").forEach(e=>e.remove());
  // chaque case est dans #board.children[index]
  players.forEach(p=>{
    let idx = p.pos-1;
    let targetCase = document.getElementById("board").children[idx];
    if(targetCase){
      let token = document.createElement("div");
      token.className="player-token";
      token.style.background=p.color;
      token.style.position="absolute";
      token.style.width="20px";
      token.style.height="20px";
      token.style.borderRadius="50%";
      token.style.border="2px solid #fff";
      token.style.transform="translate(20px,20px)";
      targetCase.style.position="relative";
      targetCase.appendChild(token);
    }
  });
}

/* Tour */
function updateStatus(){
  let p = players[currentPlayerIndex];
  document.getElementById("status").textContent = `🎯 Au tour de ${p.name}`;
}

function validateScore(){
  let score = parseInt(document.getElementById("scoreInput").value);
  if(isNaN(score)||score<0||score>60){alert("Score invalide !");return;}
  processTurn(score);
}

function getAdvance(score){
  if(score<=10) return 1;
  if(score<=20) return 2;
  if(score<=40) return 3;
  return 4;
}

function processTurn(score){
  let p = players[currentPlayerIndex];
  // Vérif défi
  if(mustSucceedDefi[p.name]){
    if(score<10){
      log(`${p.name} échoue le défi (<10 pts) → reste bloqué`);
      mustSucceedDefi[p.name]=false;
      nextPlayer();
      return;
    } else {
      log(`${p.name} réussit le défi !`);
      mustSucceedDefi[p.name]=false;
    }
  }
  let advance = getAdvance(score);
  p.pos += advance;
  if(p.pos>NUM_CELLS) p.pos = NUM_CELLS;
  log(`${p.name} avance de ${advance} cases → case ${p.pos}`);
  if(p.pos===NUM_CELLS){
    showPopup("🏆 Victoire",`Bravo ${p.name} a gagné la partie !`,()=>{});
    document.getElementById("restart-btn").style.display="inline-block";
    return;
  }
  let type = boardCases[p.pos-1];
  if(type!=="neutre"){
    handleSpecial(p,type);
  } else {
    drawPlayers();
    nextPlayer();
  }
}

function handleSpecial(player,type){
  switch(type){
    case "bonus":
      showPopup("🎉 Bonus","Avance de 2 cases supplémentaires !",()=>{
        player.pos+=2;
        if(player.pos>NUM_CELLS) player.pos=NUM_CELLS;
        drawPlayers();
        nextPlayer();
      });
      break;
    case "malus":
      showPopup("💥 Malus","Recule de 5 cases !",()=>{
        player.pos=Math.max(1,player.pos-5);
        drawPlayers();
        nextPlayer();
      });
      break;
    case "teleport":
      showPopup("🌀 Téléportation","Tu es transporté à la case 50 !",()=>{
        player.pos=50;
        drawPlayers();
        nextPlayer();
      });
      break;
    case "defi":
      showPopup("🎯 Défi précision","Au prochain tour, tu dois faire au moins 10 points ou rester bloqué !",()=>{
        mustSucceedDefi[player.name]=true;
        drawPlayers();
        nextPlayer();
      });
      break;
    case "attack":
      showPopup("🎯 Attaque !","Choisis un adversaire et lance une fléchette pour le faire reculer.",()=>{
        triggerAttack(player);
      });
      break;
  }
}

function triggerAttack(player){
  let opponents = players.filter(p=>p!==player);
  let names = opponents.map(o=>o.name).join(", ");
  let targetName = prompt("Qui veux-tu attaquer ? ("+names+")");
  let target = opponents.find(o=>o.name===targetName);
  if(!target){ nextPlayer(); return; }
  let s = parseInt(prompt("Score de ton tir d'attaque ?"));
  if(isNaN(s)){ nextPlayer(); return; }
  let recule=1;
  if(s>10 && s<=20) recule=2;
  else if(s>20 && s<=40) recule=3;
  else if(s>40) recule=4;
  target.pos=Math.max(1,target.pos-recule);
  log(`${player.name} attaque ${target.name} → recule de ${recule} cases !`);
  drawPlayers();
  nextPlayer();
}

function nextPlayer(){
  currentPlayerIndex=(currentPlayerIndex+1)%players.length;
  updateStatus();
}

/* Popup */
function showPopup(title,message,callback){
  document.getElementById("popup-title").textContent=title;
  document.getElementById("popup-message").textContent=message;
  document.getElementById("popup").style.display="flex";
  pendingEffect=callback;
}
function closePopup(){
  document.getElementById("popup").style.display="none";
  if(pendingEffect) pendingEffect();
  pendingEffect=null;
}

/* Logs */
function log(msg){
  document.getElementById("log").innerHTML+=msg+"<br>";
  document.getElementById("log").scrollTop=document.getElementById("log").scrollHeight;
}
</script>
</body>
</html>
